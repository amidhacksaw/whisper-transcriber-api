<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisper 語音轉文字工具</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .section {
      max-width: 700px;
      width: 100%;
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 0 16px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
    }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.7rem 1.5rem;
      background: #2a65f8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 1rem;
    }
    .hint {
      color: #d11a1a;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      margin-bottom: 1.5rem;
      display: block;
    }
  </style>
</head>
<body>
  <div class="section">
    <h1>轉換中心</h1>

    <label for="audio">音檔上傳</label>
    <input type="file" id="audio" accept="audio/*" />
    <div class="hint">⚠️ 建議使用 .mp3 或 .wav 格式，避免發生格式錯誤。若使用其他格式，建議先轉檔後再上傳。</div>

    <label for="format">輸出格式</label>
    <select id="format">
      <option value="txt">純文字（.txt）</option>
      <option value="srt">字幕檔（.srt）</option>
    </select>

    <button onclick="startTranscription()">開始轉換</button>
    <progress id="progress" value="0" max="100" style="display:none;"></progress>
    <div id="percent" style="font-size:0.9rem; margin-top: 0.3rem;"></div>
    <div id="result"></div>
  </div>

  <script>
    const API_URL = "https://whisper-transcriber-api.onrender.com/transcribe";

    function startTranscription() {
      const fileInput = document.getElementById("audio");
      const format = document.getElementById("format").value;
      const progressBar = document.getElementById("progress");
      const percentLabel = document.getElementById("percent");
      const resultDiv = document.getElementById("result");

      if (!fileInput.files[0]) {
        alert("請選擇音檔！");
        return;
      }

      const formData = new FormData();
      formData.append("audio", fileInput.files[0]);
      formData.append("format", format);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", API_URL);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          progressBar.style.display = "block";
          percentLabel.textContent = `${Math.round((e.loaded / e.total) * 100)}%`;
          progressBar.value = (e.loaded / e.total) * 100;
        }
      };

      xhr.onload = () => {
        percentLabel.textContent = "";
        progressBar.style.display = "none";

        if (xhr.status === 200) {
          if (format === "txt") {
            const res = JSON.parse(xhr.responseText);
            const blob = new Blob([res.text], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "transcription.txt";
            link.click();
            resultDiv.innerHTML = "✅ 文字檔已下載。";
          } else {
            const blob = xhr.response;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "result.srt";
            link.click();
            resultDiv.innerHTML = "✅ 字幕檔已下載。";
          }
        } else {
          try {
            const err = JSON.parse(xhr.responseText);
            resultDiv.innerHTML = `<div style='color: red;'>❌ 錯誤：${err.error || err.message}</div>`;
          } catch (e) {
            resultDiv.innerHTML = `<div style='color: red;'>❌ 發生未知錯誤</div>`;
          }
        }
      };

      xhr.responseType = format === "srt" ? "blob" : "text";
      xhr.send(formData);
    }
  </script>
</body>
</html>
